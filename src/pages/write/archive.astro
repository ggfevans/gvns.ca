---
import { getCollection } from "astro:content";
import BaseLayout from "@layouts/BaseLayout.astro";
import TagList from "@components/TagList.astro";
import WriteNav from "@components/WriteNav.astro";
import { formatDate } from "@utils/date";
import { breadcrumbSchema, normalizeSiteUrl, toJsonLd } from "@utils/json-ld";

const posts = (await getCollection("writing"))
    .filter((post) => (import.meta.env.PROD ? !post.data.draft : true))
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Group posts by year â†’ month
const grouped = new Map<number, Map<string, typeof posts>>();
for (const post of posts) {
    const year = post.data.pubDate.getFullYear();
    const month = post.data.pubDate.toLocaleString("en-CA", { month: "long" });

    if (!grouped.has(year)) grouped.set(year, new Map());
    const yearMap = grouped.get(year)!;
    if (!yearMap.has(month)) yearMap.set(month, []);
    yearMap.get(month)!.push(post);
}

const siteUrl = normalizeSiteUrl(Astro.site);
const breadcrumbJsonLd = toJsonLd(
    breadcrumbSchema([
        { name: "Home", url: siteUrl },
        { name: "Write", url: `${siteUrl}/write` },
        { name: "Archive", url: `${siteUrl}/write/archive` },
    ]),
);
---

<BaseLayout
    title="Archive | Write"
    description="Browse all posts by date."
    accent="p4-amber"
    breadcrumbs={[
        { label: "Home", href: "/" },
        { label: "Write", href: "/write" },
        { label: "Archive" },
    ]}
>
    <script
        type="application/ld+json"
        set:html={breadcrumbJsonLd}
        slot="head"
    />
    <main id="main-content" class="archive-page">
        <h1>Archive</h1>
        <WriteNav current="archive" />
        <p class="intro">All posts, organised by date.</p>

        {posts.length === 0 && (
            <p class="no-posts">No posts yet. Check back soon!</p>
        )}

        <div class="timeline">
            {[...grouped.entries()].map(([year, months]) => (
                <section class="timeline-year">
                    <h2 class="year-heading">{year}</h2>
                    <div class="year-content">
                        {[...months.entries()].map(([month, monthPosts]) => (
                            <div class="timeline-month">
                                <h3 class="month-heading">{month}</h3>
                                <div class="month-entries">
                                    {monthPosts.map((post) => {
                                        const canonicalSlug = post.slug.replace(/\/+$/, "");
                                        return (
                                            <article class="timeline-entry">
                                                <div class="entry-dot" />
                                                <div class="entry-content">
                                                    <a href={`/write/${canonicalSlug}/`} class="entry-title">
                                                        {post.data.title}
                                                    </a>
                                                    <time datetime={post.data.pubDate.toISOString()}>
                                                        {formatDate(post.data.pubDate)}
                                                    </time>
                                                    <p class="entry-description">{post.data.description}</p>
                                                    <TagList tags={post.data.tags} />
                                                </div>
                                            </article>
                                        );
                                    })}
                                </div>
                            </div>
                        ))}
                    </div>
                </section>
            ))}
        </div>
    </main>
</BaseLayout>

<style>
    .archive-page {
        max-width: var(--width-content);
        margin: 0 auto;
    }

    h1 {
        font-size: var(--text-4xl);
        line-height: 1.2;
        letter-spacing: -0.01em;
        margin-bottom: 0.5rem;
    }

    .intro {
        color: var(--colour-text-secondary);
        font-size: var(--text-lg);
        margin-bottom: 2.5rem;
    }

    .no-posts {
        color: var(--colour-text-secondary);
        font-style: italic;
    }

    /* Timeline structure */
    .timeline {
        display: flex;
        flex-direction: column;
        gap: 2.5rem;
    }

    /* Year sections */
    .year-heading {
        font-size: var(--text-2xl);
        color: var(--colour-accent-primary);
        margin: 0 0 1.25rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--colour-accent-primary);
    }

    .year-content {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        padding-left: 1rem;
    }

    /* Month subgroups */
    .month-heading {
        font-size: var(--text-lg);
        font-weight: 600;
        color: var(--colour-text-secondary);
        margin: 0 0 0.75rem;
    }

    .month-entries {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding-left: 1rem;
        border-left: 2px solid var(--colour-border);
    }

    /* Individual entries */
    .timeline-entry {
        position: relative;
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }

    .entry-dot {
        flex-shrink: 0;
        width: 10px;
        height: 10px;
        background: var(--colour-accent-primary);
        border-radius: 50%;
        margin-top: 0.45rem;
        margin-left: -1.375rem;
    }

    .entry-content {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        min-width: 0;
    }

    .entry-title {
        font-size: var(--text-base);
        font-weight: 600;
        color: var(--colour-text-primary);
        text-decoration: none;
        transition: color var(--transition-fast);
        line-height: 1.4;
    }

    .entry-title:hover {
        color: var(--colour-accent-primary);
    }

    time {
        font-size: var(--text-sm);
        color: var(--colour-text-secondary);
    }

    .entry-description {
        font-size: var(--text-sm);
        color: var(--colour-text-secondary);
        line-height: 1.5;
        margin: 0.125rem 0 0.25rem;
    }

    /* Responsive */
    @media (max-width: 640px) {
        .year-content {
            padding-left: 0.5rem;
        }

        .month-entries {
            padding-left: 0.75rem;
        }

        .entry-dot {
            margin-left: -1.125rem;
        }
    }
</style>
