---
import { getCollection } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import { breadcrumbSchema, normalizeSiteUrl, toJsonLd } from '@utils/json-ld';

const posts = await getCollection('writing', ({ data }) => {
  return import.meta.env.PROD ? !data.draft : true;
});

// Count posts per tag
const tagCounts = new Map<string, number>();
posts.forEach((post) => {
  post.data.tags.forEach((tag) => {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
  });
});

// Sort tags alphabetically
const sortedTags = [...tagCounts.entries()].sort((a, b) =>
  a[0].localeCompare(b[0])
);

const siteUrl = normalizeSiteUrl(Astro.site);
const breadcrumbJsonLd = toJsonLd(breadcrumbSchema([
  { name: 'Home', url: siteUrl },
  { name: 'Writing', url: `${siteUrl}/writing` },
  { name: 'Tags', url: `${siteUrl}/writing/tags` },
]));
---

<BaseLayout
  title="Tags | gvns.ca"
  description="Browse all writing tags."
>
  <script type="application/ld+json" set:html={breadcrumbJsonLd} slot="head" />
  <main id="main-content" class="tags-page">
    <h1>Tags</h1>
    <p class="intro">Browse posts by topic.</p>

    {sortedTags.length > 0 ? (
      <ul class="tag-list">
        {sortedTags.map(([tag, count]) => (
          <li>
            <a href={`/writing/tags/${tag}`} class="tag-link">
              <span class="tag-name">{tag}</span>
              <span class="tag-count">({count})</span>
            </a>
          </li>
        ))}
      </ul>
    ) : (
      <p class="no-tags">No tags yet.</p>
    )}
  </main>
</BaseLayout>

<style>
  .tags-page {
    max-width: var(--width-content);
    margin: 0 auto;
  }

  h1 {
    font-size: var(--text-4xl);
    line-height: 1.2;
    letter-spacing: -0.01em;
    margin-bottom: 0.5rem;
  }

  .intro {
    color: var(--colour-text-secondary);
    margin-bottom: 2rem;
  }

  .tag-list {
    list-style: none;
    padding: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .tag-link {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem 0.75rem;
    background: var(--colour-bg-secondary);
    border-radius: 6px;
    text-decoration: none;
    transition: background-color var(--transition-fast);
  }

  .tag-link:hover {
    background: var(--colour-bg-tertiary);
  }

  .tag-link:focus-visible {
    outline: 2px solid var(--colour-accent-primary);
    outline-offset: 2px;
  }

  .tag-name {
    color: var(--colour-accent-primary);
    font-weight: 500;
  }

  .tag-count {
    color: var(--colour-text-secondary);
    font-size: var(--text-sm);
  }

  .no-tags {
    color: var(--colour-text-secondary);
    font-style: italic;
  }
</style>
