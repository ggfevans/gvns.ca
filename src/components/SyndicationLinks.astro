---
import { safeUrl } from '@utils/format';

interface SyndicationEntry {
  platform: 'bluesky' | 'mastodon' | 'threads' | 'linkedin';
  url: string;
  syndicatedAt: Date;
}

interface Props {
  syndication?: SyndicationEntry[];
  postUrl: string;
  postTitle: string;
}

const { syndication = [], postUrl, postTitle } = Astro.props;

const platformNames: Record<string, string> = {
  bluesky: 'Bluesky',
  mastodon: 'Mastodon',
  threads: 'Threads',
  linkedin: 'LinkedIn',
};

const shareText = encodeURIComponent(`${postTitle} ${postUrl}`);
const shareUrl = encodeURIComponent(postUrl);
const safeSyndication = syndication
  .map((entry) => ({ ...entry, safeHref: safeUrl(entry.url) }))
  .filter((entry): entry is SyndicationEntry & { safeHref: string } => Boolean(entry.safeHref));

const shareLinks = [
  {
    name: 'Threads',
    href: `https://www.threads.net/intent/post?text=${shareText}`,
  },
  {
    name: 'LinkedIn',
    href: `https://www.linkedin.com/sharing/share-offsite/?url=${shareUrl}`,
  },
];
---

<aside class="gvns-syndication">
  {safeSyndication.length > 0 && (
    <div class="gvns-syndication-links">
      <span class="gvns-syndication-label">Also posted to:</span>
      <ul>
        {safeSyndication.map((entry) => (
          <li>
            <a
              href={entry.safeHref}
              class="u-syndication"
              rel="noopener noreferrer syndication"
              target="_blank"
            >
              {platformNames[entry.platform] || entry.platform}
            </a>
          </li>
        ))}
      </ul>
    </div>
  )}

  <div class="gvns-share-links">
    <span class="gvns-syndication-label">Share to:</span>
    <ul>
      {shareLinks.map((link) => (
        <li>
          <a href={link.href} target="_blank" rel="noopener noreferrer">
            {link.name}
          </a>
        </li>
      ))}
    </ul>
  </div>
</aside>

<style>
  .gvns-syndication {
    margin-top: 2rem;
    padding: 1rem 0;
    border-top: 1px solid var(--colour-border);
    font-size: 0.875rem;
    color: var(--colour-text-secondary);
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .gvns-syndication-links,
  .gvns-share-links {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .gvns-syndication-label {
    font-weight: 500;
    color: var(--colour-text-secondary);
  }

  .gvns-syndication ul {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .gvns-syndication ul li:not(:last-child)::after {
    content: "Â·";
    margin-left: 0.5rem;
    color: var(--colour-text-secondary);
  }

  .gvns-syndication a {
    color: var(--colour-accent-primary);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .gvns-syndication a:hover {
    color: var(--colour-accent-hover);
  }
</style>
