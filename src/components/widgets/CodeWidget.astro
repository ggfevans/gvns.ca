---
import { relativeTime } from '@utils/format';

interface Props { compact?: boolean; }
const { compact = false } = Astro.props;

interface Commit {
  repo: string;
  message: string;
  sha: string;
  date: string;
  url: string;
}

interface GitHubData {
  lastUpdated: string | null;
  recentCommits: Commit[];
  stats: { commitsThisWeek: number; commitsThisMonth: number; repositoriesThisWeek: number };
  repositories: { name: string; description: string; language: string; stars: number; url: string }[];
}

let data: GitHubData = { lastUpdated: null, recentCommits: [], stats: { commitsThisWeek: 0, commitsThisMonth: 0, repositoriesThisWeek: 0 }, repositories: [] };
try {
  const imported = (await import('../../data/github.json')).default as Partial<GitHubData>;
  data = {
    lastUpdated: imported.lastUpdated ?? null,
    recentCommits: Array.isArray(imported.recentCommits) ? imported.recentCommits : [],
    stats: imported.stats && typeof imported.stats === 'object'
      ? { commitsThisWeek: imported.stats.commitsThisWeek ?? 0, commitsThisMonth: imported.stats.commitsThisMonth ?? 0, repositoriesThisWeek: imported.stats.repositoriesThisWeek ?? 0 }
      : { commitsThisWeek: 0, commitsThisMonth: 0, repositoriesThisWeek: 0 },
    repositories: Array.isArray(imported.repositories) ? imported.repositories : [],
  };
} catch (e) {
  if (import.meta.env.DEV) console.error('Failed to load GitHub data for CodeWidget:', e);
}

const latestCommit = data.recentCommits[0] ?? null;
---

{compact ? (
  <article class="gvns-widget-compact gvns-widget-compact--code">
    <div class="gvns-widget-compact__label">Now Coding</div>
    {latestCommit ? (
      <a href="/code" class="gvns-widget-compact__body">
        <div class="gvns-widget-compact__info">
          <p class="gvns-widget-compact__title gvns-widget-compact__title--mono">{latestCommit.repo}</p>
          <p class="gvns-widget-compact__subtitle">{latestCommit.message}</p>
        </div>
      </a>
    ) : (
      <p class="gvns-widget-compact__empty">No recent commits.</p>
    )}
  </article>
) : (
  <article class="gvns-widget gvns-widget--code">
    <div class="gvns-widget__label">Code</div>
    {latestCommit ? (
      <div class="gvns-widget__content">
        <p class="gvns-widget__repo">{latestCommit.repo}</p>
        <p class="gvns-widget__detail">{latestCommit.message}</p>
        <time class="gvns-widget__time" datetime={latestCommit.date}>
          {relativeTime(latestCommit.date)}
        </time>
      </div>
    ) : (
      <p class="gvns-widget__empty">No recent commits.</p>
    )}
    <a href="/code" class="gvns-widget__link">
      View Full Activity <span aria-hidden="true">&rarr;</span>
    </a>
  </article>
)}

<style>
  .gvns-widget--code {
    border-left-color: var(--colour-p1-violet);
  }

  .gvns-widget--code .gvns-widget__link:hover {
    color: var(--colour-p1-violet);
  }

  .gvns-widget__repo {
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    color: var(--colour-p1-violet);
    margin: 0 0 var(--space-1) 0;
  }

  .gvns-widget-compact--code {
    border-top: 3px solid var(--colour-p1-violet);
  }

  .gvns-widget-compact__title--mono {
    font-family: var(--font-mono);
  }
</style>
