---
import { relativeTime } from '@utils/format';

interface Track {
  name: string;
  artist: string;
  album?: string;
  albumArtUrl?: string;
  listenedAt?: string;
}

interface ListeningData {
  lastUpdated: string | null;
  recentTracks: Track[];
  topArtists: { name: string; playCount: number; imageUrl?: string }[];
  stats: { tracksToday: number; artistsToday: number };
}

let data: ListeningData = { lastUpdated: null, recentTracks: [], topArtists: [], stats: { tracksToday: 0, artistsToday: 0 } };
try {
  data = (await import('../../data/listening.json')).default as ListeningData;
} catch { /* data unavailable */ }

const latestTrack = data.recentTracks[0] ?? null;
---

<article class="gvns-widget gvns-widget--listen">
  <div class="gvns-widget__label">Listen</div>
  {latestTrack ? (
    <div class="gvns-widget__content gvns-widget__content--row">
      {latestTrack.albumArtUrl ? (
        <img
          src={latestTrack.albumArtUrl}
          alt={`${latestTrack.album || latestTrack.name} album art`}
          class="gvns-widget__art"
          width="64"
          height="64"
          loading="lazy"
          decoding="async"
        />
      ) : (
        <div class="gvns-widget__art-placeholder" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="24" height="24"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
        </div>
      )}
      <div>
        <p class="gvns-widget__detail gvns-widget__detail--bold">{latestTrack.name}</p>
        <p class="gvns-widget__meta">{latestTrack.artist}</p>
        {latestTrack.listenedAt && (
          <time class="gvns-widget__time" datetime={latestTrack.listenedAt}>
            {relativeTime(latestTrack.listenedAt)}
          </time>
        )}
      </div>
    </div>
  ) : (
    <p class="gvns-widget__empty">Nothing playing right now.</p>
  )}
  <a href="/listen" class="gvns-widget__link">
    View Full Activity <span aria-hidden="true">&rarr;</span>
  </a>
</article>

<style>
  .gvns-widget--listen {
    border-left-color: var(--colour-p3-emerald);
  }

  .gvns-widget--listen .gvns-widget__link:hover {
    color: var(--colour-p3-emerald);
  }

  .gvns-widget__art {
    width: 64px;
    height: 64px;
    border-radius: 6px;
    object-fit: cover;
    flex-shrink: 0;
  }

  .gvns-widget__art-placeholder {
    width: 64px;
    height: 64px;
    border-radius: 6px;
    background: var(--colour-bg-tertiary);
    color: var(--colour-text-muted);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
</style>
