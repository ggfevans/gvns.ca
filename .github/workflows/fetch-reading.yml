name: Fetch Reading Data

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch Hardcover data
        id: fetch
        env:
          HARDCOVER_TOKEN: ${{ secrets.HARDCOVER_TOKEN }}
          HARDCOVER_USER_ID: ${{ secrets.HARDCOVER_USER_ID }}
        run: |
          set -euo pipefail

          if [ -z "${HARDCOVER_TOKEN:-}" ] || [ -z "${HARDCOVER_USER_ID:-}" ]; then
            echo "Hardcover credentials not configured, skipping"
            exit 0
          fi

          QUERY='query GetUserBooks($userId: Int!) {
            user_books(
              where: { user_id: { _eq: $userId } }
              order_by: { updated_at: desc }
              limit: 50
            ) {
              status_id
              rating
              progress
              updated_at
              book {
                title
                contributions(limit: 1) {
                  author { name }
                }
                image { url }
                slug
              }
            }
          }'

          PAYLOAD=$(jq -n \
            --arg query "$QUERY" \
            --argjson userId "$HARDCOVER_USER_ID" \
            '{ query: $query, variables: { userId: $userId } }')

          HTTP_CODE=$(curl -s -o /tmp/hc_response.json -w "%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${HARDCOVER_TOKEN}" \
            -d "$PAYLOAD" \
            "https://api.hardcover.app/v1/graphql")

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Error: Hardcover API returned HTTP $HTTP_CODE"
            exit 1
          fi

          RESPONSE=$(cat /tmp/hc_response.json)
          rm -f /tmp/hc_response.json

          # Check for GraphQL errors
          if echo "$RESPONSE" | jq -e '.errors' > /dev/null 2>&1; then
            echo "Error: GraphQL errors from Hardcover API"
            echo "$RESPONSE" | jq -r '.errors[].message' 2>/dev/null
            echo "Full error details: $(echo "$RESPONSE" | jq '.errors' 2>/dev/null)"
            exit 1
          fi

          # Validate response has data
          if ! echo "$RESPONSE" | jq -e '.data.user_books' > /dev/null 2>&1; then
            echo "Error: Invalid response structure from Hardcover API"
            exit 1
          fi

          mkdir -p src/data

          # Map status_id: 1=want, 2=reading, 3=finished, 4=dnf, 5=dropped
          echo "$RESPONSE" | jq '{
            lastUpdated: (now | todate),
            currentlyReading: [
              .data.user_books[]
              | select(.status_id == 2)
              | {
                  title: .book.title,
                  author: (.book.contributions[0].author.name // "Unknown"),
                  coverUrl: .book.image.url,
                  hardcoverUrl: ("https://hardcover.app/books/" + .book.slug),
                  progress: (.progress // 0)
                }
            ],
            finished: [
              .data.user_books[]
              | select(.status_id == 3)
              | {
                  title: .book.title,
                  author: (.book.contributions[0].author.name // "Unknown"),
                  coverUrl: .book.image.url,
                  hardcoverUrl: ("https://hardcover.app/books/" + .book.slug),
                  rating: (.rating // null),
                  dateFinished: .updated_at
                }
            ],
            wantToRead: [
              .data.user_books[]
              | select(.status_id == 1)
              | {
                  title: .book.title,
                  author: (.book.contributions[0].author.name // "Unknown"),
                  coverUrl: .book.image.url,
                  hardcoverUrl: ("https://hardcover.app/books/" + .book.slug)
                }
            ]
          }' > src/data/reading.json

          echo "Successfully fetched reading data"
          cat src/data/reading.json | jq '{
            currently_reading: (.currentlyReading | length),
            finished: (.finished | length),
            want_to_read: (.wantToRead | length)
          }'

      - name: Commit and push if changed
        if: steps.fetch.outcome == 'success' && hashFiles('src/data/reading.json') != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/data/reading.json
          if ! git diff --staged --quiet; then
            git commit -m "chore: update reading data"

            MAX_RETRIES=3
            for i in $(seq 1 $MAX_RETRIES); do
              if git push 2>&1; then
                echo "Push succeeded on attempt $i"
                exit 0
              fi
              echo "::warning::git push failed (attempt $i/$MAX_RETRIES)"
              sleep $((i * 5))
            done

            echo "::error::git push failed after $MAX_RETRIES attempts"
            exit 1
          else
            echo "No changes to commit"
          fi
